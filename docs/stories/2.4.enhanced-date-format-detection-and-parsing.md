# Story 2.4: Enhanced Date Format Detection and Parsing

## Status
Done

## Story

**As a** System Administrator,
**I want** the CSV import system to correctly detect and parse date formats across entire files (UK vs US format) before processing any records,
**so that** I can reliably import Lloyds Bank and Stripe data without date parsing errors when the data uses UK date format (dd/mm/yyyy) instead of the system incorrectly assuming US format (mm/dd/yyyy) on a per-record basis.

## Acceptance Criteria

1. System must scan entire date columns in CSV files to determine the predominant date format (UK dd/mm/yyyy vs US mm/dd/yyyy) before processing any individual records
2. Date format detection must apply the identified format consistently across ALL records in the file, not vary per record
3. Lloyds Bank CSV imports with UK date formats (e.g., "31/07/2025", "18/06/2025") must parse correctly throughout the entire file
4. Stripe CSV imports with various date formats must be detected and parsed consistently throughout the file
5. System must maintain backwards compatibility with existing US format dates in previously working files
6. Enhanced error messages must clearly indicate which date format was detected and applied to the file
7. Date format detection must handle mixed delimiter formats (both "/" and "-" separators)
8. System must log the detected date format for debugging and audit purposes
9. If date format cannot be determined reliably, system must provide clear guidance on expected formats

## Tasks / Subtasks

- [x] Task 1: Implement File-Level Date Format Detection (AC: 1, 2, 6, 8)
  - [x] Create new method `detectDateFormat()` in CsvParsingService that scans entire date columns
  - [x] Implement logic to analyze date patterns across all rows before processing
  - [x] Add confidence scoring for UK vs US format detection based on unambiguous dates
  - [x] Add comprehensive logging of format detection decisions and confidence levels
  - [x] Update parseDate method to accept format parameter instead of auto-detecting per record

- [x] Task 2: Enhance Date Parsing Logic (AC: 3, 4, 5, 7)
  - [x] Refactor parseDate method to use pre-determined format from detectDateFormat
  - [x] Support both "/" and "-" date separators consistently within detected format
  - [x] Maintain backwards compatibility by defaulting to UK format when detection is uncertain
  - [x] Add validation to ensure parsed dates are reasonable (not future dates beyond reasonable range)
  - [x] Handle edge cases where format detection may be ambiguous (e.g., dates 01-12 range)

- [x] Task 3: Update CSV Parsing Services Integration (AC: 2, 8)
  - [x] Modify parseLloydsBankCsv to call detectDateFormat before processing rows
  - [x] Modify parseStripeCsv to call detectDateFormat for date fields
  - [x] Update both services to pass detected format to parseDate method consistently
  - [x] Add format detection results to CSV parsing result logging and error reporting
  - [x] Ensure format detection happens once per file, not per record

- [x] Task 4: Enhanced Error Handling and Validation (AC: 6, 9)
  - [x] Improve error messages to include detected date format information
  - [x] Add specific error messages when date format detection fails or is ambiguous
  - [x] Provide clear guidance to administrators on expected date formats
  - [x] Add validation warnings when confidence in format detection is low
  - [x] Include format detection summary in parsing result messages

- [x] Task 5: Testing and Backwards Compatibility (AC: 5, all)
  - [x] Update existing CsvParsingService tests to verify backwards compatibility
  - [x] Create comprehensive test cases for UK date format detection and parsing
  - [x] Test mixed separator formats (both "/" and "-" within same format type)
  - [x] Create test cases for ambiguous date scenarios and error handling
  - [x] Add integration tests with sample files containing different date formats
  - [x] Verify all existing functionality continues to work without modification

## Dev Notes

### Previous Story Insights
**Key learnings from Stories 1.5, 1.10, and 1.10.1** [Source: Story completion analysis]:
- Story 1.10.1 attempted to fix UK date parsing but implemented per-record detection instead of per-file detection
- Current parseDate method (lines 448-491 in CsvParsingService.ts) tries to detect format per record, causing inconsistent parsing within same file
- File upload functionality and API integration works correctly - issue is purely in date parsing logic
- Real-world production files confirmed to use UK date format (dd/mm/yyyy) consistently
- Existing CSV parsing architecture is solid - only date format detection strategy needs enhancement

### Current Implementation Analysis
**CsvParsingService Structure** [Source: src/lib/CsvParsingService.ts]:
- Main service class: `CsvParsingService` in `src/lib/CsvParsingService.ts`
- Current parseDate method (lines 448-491): Attempts UK format detection per record with fallback
- Integration points: `parseLloydsBankCsv` (line 156) and `parseStripeCsv` (line 280) both call parseDate
- Issue: Per-record format detection can lead to inconsistent parsing within same file
- Solution: Move format detection to file level before processing individual records

### Technical Architecture Requirements
**Backend Service Architecture** [Source: docs/architecture/component-architecture.md]:
- File Location: `src/lib/CsvParsingService.ts` - CSV parsing service with privacy rule enforcement
- Integration: Called by API routes in `src/app/api/reconciliation/` for both Lloyds and Stripe files
- Must maintain existing interface and error handling patterns for upstream API integration
- Logging integration: Service uses console.log for debugging - must maintain consistent logging patterns

### Data Privacy and Security Constraints
**Critical Privacy Requirements** [Source: Stories 1.5-1.8 NFR requirements]:
- NFR1: Balance fields from bank CSV must remain discarded immediately, never stored
- NFR2: Bank account numbers must remain immediately hashed, original values discarded
- Date format detection must not impact existing privacy enforcement mechanisms
- No sensitive data should be logged during format detection process

### Technology Stack Requirements
**Implementation Technology** [Source: docs/architecture/tech-stack-alignment.md]:
- TypeScript 5.9.2 with strict mode for all modifications
- Node.js environment with existing Prisma 6.13.0 integration
- Must maintain compatibility with existing API routes and error handling patterns
- Jest testing framework for comprehensive test coverage

### File Structure and Implementation Targets
**Primary Files to Modify**:
- `src/lib/CsvParsingService.ts` - Main parsing logic updates for format detection
- `src/__tests__/lib/CsvParsingService.test.ts` - Enhanced test coverage for format detection
- No interface changes required - internal method enhancement only

### Enhanced Date Format Detection Strategy
**Format Detection Logic Requirements**:
- Scan all date values in CSV before processing any records
- Look for unambiguous dates (day > 12) to determine UK format definitively
- Use confidence scoring: High confidence when multiple unambiguous dates found
- Default to US format for ambiguous cases (backwards compatibility)
- Support both "/" and "-" separators within the same detected format type
- Log detection results with confidence levels for debugging

### Backwards Compatibility Requirements
**Existing Functionality Preservation**:
- All existing test cases must continue to pass without modification
- US format files must continue to work exactly as before
- API response formats and error structures must remain unchanged
- Integration with ReconciliationLog and PaymentSource models unchanged
- Performance impact should be minimal (single pass through dates before parsing)

## Testing

### Test File Locations
- Unit tests: `src/__tests__/lib/CsvParsingService.test.ts` (enhance existing)
- Integration tests: Test with various date format CSV files
- Backwards compatibility: Ensure all existing 28+ tests continue to pass

### Testing Requirements
- Unit tests for `detectDateFormat` method with various date pattern scenarios
- UK date format detection accuracy tests with unambiguous dates (31/07/2025, etc.)
- Mixed separator format tests (both "/" and "-" within same format)
- Ambiguous date scenario tests (dates in 01-12 range only)
- Backwards compatibility tests ensuring US format files continue to work
- Error handling tests for format detection failures
- Integration tests with real-world CSV files provided by user
- Performance tests to ensure format detection doesn't significantly impact parsing speed

### Testing Framework
- Jest for unit testing [Source: docs/architecture/tech-stack-alignment.md]
- TypeScript test files following existing project patterns
- Comprehensive coverage for all format detection logic paths
- Real-world data file testing to ensure production reliability

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-10 | 1.0 | Story creation for enhanced date format detection with file-level scanning | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent James

### Debug Log References
- All existing tests passed without modification, confirming backwards compatibility
- New date format detection logs show detailed analysis of each CSV file
- Enhanced error messages now include format detection information
- Test output demonstrates HIGH/MEDIUM/LOW confidence scoring working correctly

### Completion Notes List
1. **File-Level Date Format Detection**: Implemented `detectDateFormat()` method that analyzes all dates in a CSV before processing any records
2. **Enhanced Date Parsing**: Refactored `parseDate()` to accept format parameter, with legacy fallback for backwards compatibility
3. **CSV Service Integration**: Updated both Lloyds Bank and Stripe CSV parsing to use file-level format detection
4. **Comprehensive Testing**: Added new test cases covering UK format detection, dash separators, and enhanced error messages
5. **Backwards Compatibility**: All existing functionality preserved - ambiguous dates default to UK format per requirements
6. **Logging & Error Handling**: Added detailed logging of format detection decisions and enhanced error messages with format context

### File List
- `src/lib/CsvParsingService.ts` - Enhanced with detectDateFormat method and updated parseDate logic
- `src/__tests__/lib/CsvParsingService.test.ts` - Added comprehensive test cases for new functionality

## QA Results

_Results from QA Agent review will be populated here after implementation._