# Story 2.3: Admin Data Import/Export Page

## Status
Done

## Story

**As an** Administrator,
**I want** a dedicated data import/export page accessible only to admin users that provides WordPress user export functionality,
**so that** I can efficiently export filtered contact data in the correct format for WordPress user imports, enabling seamless user migration between systems.

## Acceptance Criteria

1. Create new admin-only page accessible at `/admin/data-import-export` with proper role-based access control
2. Page must be protected by middleware to ensure only users with admin role can access it
3. Implement WordPress User Export functionality that filters contacts based on specific criteria
4. Export must filter contacts where `membershipType = "Full"` and field `cWMPNiNAfReHOumOhBB2 >= today's date`
5. Generate CSV file with specific column headers: `user_login`, `user_email`, `role`, `first_name`, `last_name`
6. Map data correctly: `user_login` = `{firstName}{lastName}`, `user_email` = email field
7. Implement conditional role mapping: if field `hJQPtsVDFBxI1USEN83v = "Single"` then `role = "subscriber,Single Member"`, if `hJQPtsVDFBxI1USEN83v = "Double"` then `role = "subscriber,Double Member"`
8. Extract first name and last name from contact data for respective columns
9. Provide user-friendly export interface with clear download functionality
10. Display export summary showing number of records that will be exported before generating file
11. Include proper error handling for export operations with user feedback
12. Page should follow existing UI/UX patterns and styling consistency with the application

## Tasks / Subtasks

- [x] Task 1: Create Admin Data Import/Export Page Structure (AC: 1, 2, 12)
  - [x] Create new page file at `src/app/admin/data-import-export/page.tsx`
  - [x] Update middleware to protect `/admin/data-import-export` route for admin-only access
  - [x] Implement page layout following existing admin page patterns
  - [x] Add navigation link in admin section for easy access
  - [x] Apply consistent styling using existing Tailwind CSS patterns

- [x] Task 2: Implement Contact Filtering Logic (AC: 3, 4, 10)
  - [x] Create filtering service in `src/lib/export-service.ts` for WordPress export requirements
  - [x] Implement `membershipType = "Full"` filter logic
  - [x] Implement date comparison filter for `cWMPNiNAfReHOumOhBB2 >= today's date`
  - [x] Add preview functionality to show count of records matching criteria
  - [x] Include proper TypeScript interfaces for export data structures

- [x] Task 3: Build WordPress CSV Export Functionality (AC: 5, 6, 7, 8)
  - [x] Implement CSV generation with required headers: user_login, user_email, role, first_name, last_name
  - [x] Create data mapping logic: user_login = {firstName}{lastName}
  - [x] Implement conditional role mapping based on hJQPtsVDFBxI1USEN83v field values
  - [x] Extract and format first_name and last_name from contact data
  - [x] Handle edge cases for missing or malformed contact data

- [x] Task 4: Create Export API Endpoint (AC: 9, 11)
  - [x] Create API route at `src/app/api/admin/export/wordpress-users/route.ts`
  - [x] Implement GET endpoint to generate and return CSV file
  - [x] Add proper authentication and admin role verification
  - [x] Include comprehensive error handling and logging
  - [x] Implement file download response with correct headers

- [x] Task 5: Build Export User Interface (AC: 9, 10, 11, 12)
  - [x] Create export button component with loading states
  - [x] Implement export preview showing record count and filter criteria
  - [x] Add success/error feedback messages for export operations
  - [x] Include progress indicators during export generation
  - [x] Ensure responsive design following application patterns

- [x] Task 6: Testing and Quality Assurance (AC: 1-12)
  - [x] Test admin-only access control and middleware protection
  - [x] Test contact filtering logic with various date scenarios
  - [x] Test CSV generation with different field value combinations
  - [x] Test role mapping logic for Single/Double membership types
  - [x] Verify exported CSV format matches WordPress import requirements
  - [x] Test error handling scenarios and user feedback

## Dev Notes

### Admin Access Control Pattern
**Current Implementation** [Source: src/middleware.ts]:
- Lines 7, 15-18: Admin route protection pattern using `token?.role !== 'admin'` check
- Pattern for new admin routes: add `/admin/data-import-export` path to `isAdminRoute` check
- Existing admin routes use `/users` prefix, new route should follow `/admin` pattern for clarity

### Field Mapping and GHL Integration
**GHL Field Mapping** [Source: src/lib/ghl-api.ts]:
- Lines 8-21: FIELD_MAP contains required field mappings for export functionality
- `hJQPtsVDFBxI1USEN83v: 'single_or_double_membership'` - field for membership type distinction
- `cWMPNiNAfReHOumOhBB2: 'renewal_date'` - field for date comparison filter
- Contact data structure includes firstName, lastName, email as standard fields

### Database and Contact Model Structure
**Prisma Contact Model** [Source: Contact model structure]:
- Standard fields available: firstName, lastName, email, membershipType
- Custom fields stored as JSON in customFields column
- **IMPORTANT**: GHL field IDs (hJQPtsVDFBxI1USEN83v, cWMPNiNAfReHOumOhBB2) are accessed within the customFields JSON structure
- Access pattern: `contact.customFields[fieldId]` or `contact.customFields['hJQPtsVDFBxI1USEN83v']`
- Date comparison requires proper date parsing and comparison logic from customFields JSON
- Filter logic should account for potential null/undefined values in both standard fields and customFields

### API Route Patterns
**Existing API Structure** [Source: Project API patterns]:
- Admin API routes follow pattern: `/api/admin/{functionality}/route.ts`
- Authentication patterns use NextAuth token verification
- File download responses require proper Content-Type and Content-Disposition headers
- Error responses follow consistent JSON structure with appropriate HTTP status codes

### UI/UX Consistency Requirements
**Admin Page Patterns** [Source: Existing admin pages]:
- Follow layout patterns from `/users` page for consistency
- Use existing Tailwind CSS utility classes for styling
- Implement loading states, success/error feedback following established patterns
- Responsive design considerations for mobile/desktop usage

### Export Data Processing
**WordPress CSV Requirements** [Source: User requirements]:
- Column order must match: user_login, user_email, role, first_name, last_name
- user_login format: concatenate firstName and lastName without spaces
- Role mapping logic: Access `contact.customFields['hJQPtsVDFBxI1USEN83v']` → "Single" = "subscriber,Single Member", "Double" = "subscriber,Double Member"
- Date filtering: Access `contact.customFields['cWMPNiNAfReHOumOhBB2']` and compare with current date
- Handle edge cases: missing fields, invalid dates, null values in both standard fields and customFields JSON gracefully

### File Structure for Implementation
**New Files Required** [Source: Project organization]:
- `src/app/admin/data-import-export/page.tsx` - Main admin page component
- `src/app/api/admin/export/wordpress-users/route.ts` - Export API endpoint
- `src/lib/export-service.ts` - Export logic and filtering service
- `src/components/admin/ExportPreview.tsx` - Export preview component
- `src/components/admin/ExportButton.tsx` - Export button with states

**Files to Modify** [Source: Existing codebase]:
- `src/middleware.ts` - Add admin route protection for new page
- Add navigation link to admin section (location TBD based on existing admin nav)

## Testing

### Test File Locations
- Component tests: `src/__tests__/components/admin/` (new directory for admin components)
- API tests: `src/__tests__/api/admin/export/` (new directory for admin API tests)
- Service tests: `src/__tests__/lib/export-service.test.ts` (new)
- Integration tests: `src/__tests__/integration/admin-export.test.ts` (new)

### Testing Framework
- Jest & React Testing Library [Source: docs/architecture/tech-stack-alignment.md]
- Focus on admin access control, data filtering, and CSV generation
- Mock GHL API calls and contact data for consistent testing
- Test responsive behavior and user interaction patterns

### Critical Testing Requirements
- **Access Control**: Test admin-only access and middleware protection
- **Data Filtering**: Test membershipType and date filtering logic with edge cases
- **CSV Generation**: Test CSV format, headers, and data mapping accuracy
- **Role Mapping**: Test conditional role assignment based on membership type
- **Error Handling**: Test graceful handling of API failures and data issues
- **User Experience**: Test loading states, feedback messages, and export flow
- **Integration**: Test end-to-end export workflow from UI to file download

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Status
Ready for Review

### Completion Notes
- ✅ Complete admin-only data import/export page implementation at `/admin/data-import-export`
- ✅ Middleware protection successfully applied for admin route access control
- ✅ Export service with comprehensive contact filtering (membershipType="Full" and renewal_date>=today)
- ✅ WordPress CSV export with proper column mapping: user_login, user_email, role, first_name, last_name
- ✅ Conditional role mapping: Single→"subscriber,Single Member", Double→"subscriber,Double Member"
- ✅ Complete API endpoint with authentication, preview, and CSV download functionality
- ✅ User-friendly interface with export preview, loading states, and comprehensive error handling
- ✅ Full test coverage with 24 passing tests (unit + integration)
- ✅ All acceptance criteria met with proper edge case handling

### File List
**New Files Created:**
- `src/app/admin/data-import-export/page.tsx` - Main admin data import/export page
- `src/app/api/admin/export/wordpress-users/route.ts` - WordPress user export API endpoint
- `src/lib/export-service.ts` - Export filtering and CSV generation service
- `src/__tests__/lib/export-service.test.ts` - Unit tests for export service (17 tests)
- `src/__tests__/integration/admin-export.test.ts` - Integration tests (7 tests)

**Modified Files:**
- `src/middleware.ts` - Added admin route protection for `/admin/data-import-export`
- `src/components/Navigation.tsx` - Added "Data Export" navigation link in admin section

### Debug Log References
None - Implementation completed without debugging issues

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-09 | 1.0 | Story creation for admin data import/export page with WordPress user export functionality | Bob (Scrum Master) |
| 2025-08-09 | 2.0 | Complete implementation with all tasks and comprehensive testing | James (Dev Agent) |