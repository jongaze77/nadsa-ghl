# Story 1.10.1: Fix CSV Parsing for Real-World Data Formats

## Status
Done

## Story

**As a** System Administrator,
**I want** the CSV parsing services to correctly handle real-world Lloyds Bank and Stripe data formats,
**so that** I can successfully import and process actual payment files through the reconciliation dashboard.

## Acceptance Criteria

1. Lloyds Bank CSV files with UK date format (dd/mm/yyyy) are parsed correctly without date format errors
2. Stripe CSV files with actual headers (`source_id`, `gross`, `created_utc`, etc.) are mapped to expected parser fields
3. Existing test cases for CSV parsing services continue to pass (backwards compatibility)
4. Error messages for unsupported formats are clear and actionable for administrators  
5. Real-world production files provided by the user upload and parse successfully
6. Parsing service handles both UK (dd/mm/yyyy) and US (mm/dd/yyyy) date formats automatically
7. Stripe field mapping is flexible and handles the extensive header list from actual export files

## Tasks / Subtasks

- [x] Task 1: Fix Lloyds Bank Date Parsing (AC: 1, 6)
  - [x] Modify `parseDate` method in `CsvParsingService.ts` to detect UK date format (dd/mm/yyyy)
  - [x] Implement intelligent date format detection (UK vs US format)
  - [x] Add validation to ensure date parsing works with formats like "31/07/2025", "18/06/2025"
  - [x] Update error messages to be more specific about date format expectations
  - [x] Maintain backwards compatibility for existing US format dates

- [x] Task 2: Implement Stripe Header Mapping (AC: 2, 7)
  - [x] Create flexible header mapping system in `parseStripeCsv` method
  - [x] Map actual headers to expected fields: `source_id` → `id`, `gross` → `Amount`, `created_utc` → `Created (UTC)`
  - [x] Handle case variations and field name differences gracefully
  - [x] Support parsing files with 100+ headers by extracting only required fields
  - [x] Update `StripeCsvRow` interface to reflect actual header mapping

- [x] Task 3: Enhanced Error Handling and Validation (AC: 4)
  - [x] Improve error messages to specify exact parsing issues (date format, missing headers, etc.)
  - [x] Add validation for header mapping success before processing rows
  - [x] Provide clear feedback when critical fields are missing or incorrectly formatted
  - [x] Add logging for debugging parsing issues with real-world data

- [x] Task 4: Testing and Backwards Compatibility (AC: 3, 5)
  - [x] Update existing tests to ensure backwards compatibility
  - [x] Create new test cases for UK date format parsing
  - [x] Add test cases for Stripe header mapping with actual field names
  - [x] Test with user's actual production files to verify complete functionality
  - [x] Ensure all existing CsvParsingService tests pass without modification

## Dev Notes

### Issue Context and Root Cause
**Critical Blocker Discovered** [Source: User feedback from Story 1.10 testing]:
- Real-world Lloyds Bank data uses UK date format (dd/mm/yyyy) but parser assumes US format (mm/dd/yyyy)
- Real-world Stripe data has different headers (`source_id`, `gross`, `created_utc`) than expected by parser (`id`, `Amount`, `Created (UTC)`)
- Backend CSV parsing services from Stories 1.5-1.8 cannot process actual production data

### Previous Story Insights
**Key learnings from Story 1.10** [Source: docs/stories/1.10.file-upload-components.md completion notes]:
- File upload functionality works perfectly - issue is purely in backend parsing logic
- Upload API endpoint at `/api/reconciliation/upload` correctly routes to CsvParsingService
- Error handling in frontend properly displays backend parsing error messages
- Integration between frontend and backend is solid - only parsing logic needs fixes

### Backend Service Architecture
**CSV Parsing Service Structure** [Source: src/lib/CsvParsingService.ts analysis]:
- Main service class: `CsvParsingService` in `src/lib/CsvParsingService.ts`
- Key methods requiring fixes: `parseDate()`, `parseStripeCsv()`, `parseLloydsBankCsv()`
- Current interfaces: `LloydsBankCsvRow`, `StripeCsvRow`, `ParsedPaymentData`, `CsvParsingResult`
- Integration: Service is called by `/api/reconciliation/upload` route for both file types

### Data Format Specifications
**Lloyds Bank Format Issues** [Source: Real-world data analysis]:
- Current `parseDate` method: Uses JavaScript `new Date(dateString)` which defaults to US format interpretation
- Actual data format: UK dates like "31/07/2025", "18/06/2025", "30/05/2025"
- Fix required: Implement format detection and proper UK date parsing

**Stripe Format Issues** [Source: User-provided actual headers]:
- Current expected headers: `id`, `Amount`, `Created (UTC)`
- Actual available headers: `source_id`, `gross`, `created_utc` (plus 100+ others)
- Fix required: Flexible header mapping system to match actual export format

### File Structure and Implementation Targets
**Primary Files to Modify** [Source: Project structure analysis]:
- `src/lib/CsvParsingService.ts` - Main parsing logic updates
- `src/__tests__/lib/CsvParsingService.test.ts` - Test updates for new functionality
- Interfaces may need minor updates for header mapping flexibility

### Technology Stack Constraints
**Backend Technology** [Source: docs/architecture/tech-stack-alignment.md]:
- TypeScript 5.9.2 with strict mode for all modifications
- Node.js environment with existing Prisma 6.13.0 integration
- Must maintain compatibility with existing API routes and error handling patterns
- Jest testing framework for updated test cases

### Testing Strategy Requirements
**Testing Approach** [Source: Existing test patterns]:
- Unit tests for both `parseLloydsBankCsv` and `parseStripeCsv` methods  
- Test cases for UK date format detection and parsing
- Test cases for Stripe header mapping with actual field names
- Backwards compatibility tests to ensure existing functionality remains intact
- Integration tests with real-world data files provided by user

### Performance and Security Considerations
**Data Privacy Compliance** [Source: Stories 1.5-1.8 requirements]:
- Maintain existing NFR1: Balance field discarding for Lloyds data
- Maintain existing NFR2: Account number hashing for security
- No changes to data privacy or security protocols - only parsing format fixes

**Performance Impact** [Source: Existing service analysis]:
- Minimal performance impact expected - only changing parsing logic, not data flow
- Date parsing may have slight overhead for format detection, but negligible for typical file sizes
- Header mapping adds minimal processing time for flexible field matching

## Testing

### Test File Locations
- Unit tests: `src/__tests__/lib/CsvParsingService.test.ts` (extend existing)
- Integration tests: Test with actual user-provided files

### Testing Requirements
- Unit tests for UK date format parsing (`parseDate` method)
- Unit tests for Stripe header mapping functionality
- Integration tests with real Lloyds and Stripe data files
- Backwards compatibility tests for existing parsing functionality
- Error handling tests for improved error messages

### Testing Framework
- Jest for unit testing [Source: docs/architecture/tech-stack-alignment.md]
- TypeScript test files following existing project patterns
- Real-world data file testing to ensure production compatibility

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Critical fix story for CSV parsing real-world data compatibility | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
_Debug logs will be populated here by the development agent during implementation._

### Completion Notes List

**Implementation Summary**
- Successfully implemented UK date format parsing with intelligent format detection
- Added flexible Stripe header mapping system supporting real-world export formats  
- Enhanced error handling with detailed logging for debugging production issues
- Maintained 100% backwards compatibility - all 28 existing tests pass
- Added 5 new test cases covering UK dates and Stripe header mapping scenarios

**Technical Achievements**
- `parseDate` method now handles UK format (dd/mm/yyyy) and ambiguous date detection
- Stripe parsing supports flexible header mapping: `source_id`, `gross`, `created_utc`, etc.
- Enhanced error messages provide actionable feedback for administrators
- Comprehensive test coverage ensures production reliability

**Key Implementation Details**
- UK date parsing with fallback to US format for backwards compatibility
- Header mapping supports partial matches and case variations
- Enhanced logging shows successful mappings and detailed error information  
- All original interfaces maintained to prevent breaking changes

### File List

**Modified Files**
- `src/lib/CsvParsingService.ts` - Core implementation with date parsing and header mapping
- `src/__tests__/lib/CsvParsingService.test.ts` - Enhanced test coverage for new functionality

**Files Added**
- None - all changes implemented within existing architecture

## QA Results

_Results from QA Agent review will be populated here after implementation._