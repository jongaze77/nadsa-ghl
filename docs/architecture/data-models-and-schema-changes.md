# Data Models and Schema Changes

## New Data Models

### `ReconciliationLog`

  * **Purpose**: To provide a verifiable audit trail of all reconciled membership payments.
  * **Key Attributes**: `id`, `transactionFingerprint` (unique), `paymentDate`, `amount`, `source`, `transactionRef`, `reconciledAt`, `reconciledByUserId`, `contactId`.

### `PaymentSource`

  * **Purpose**: To securely store a hashed identifier for a member's payment source (e.g., bank account) to assist with future reconciliations.
  * **Key Attributes**: `id`, `hashedIdentifier` (unique), `sourceType`, `contactId`.

## Schema Integration Strategy

  * **Database Changes**: Two new tables (`ReconciliationLog`, `PaymentSource`) will be added. No modifications to existing tables are required.
  * **New Indexes**: A unique index will be created on `ReconciliationLog(transactionFingerprint)` and an index on `PaymentSource(hashedIdentifier)`.
  * **Migration Strategy**: All schema changes will be implemented via a new, single Prisma migration file.

## Duplicate Transaction Handling

To prevent re-matching previously imported data, the system will generate a unique `transactionFingerprint` for each transaction upon import.

  * **For Stripe Reports**: The unique `source_id` will be used as the fingerprint.
  * **For Bank CSVs**: A unique fingerprint will be generated by hashing the combined `Transaction date`, `Credit Amount`, and `Transaction Description`.
  * **Import Logic**: The system will check if a fingerprint exists in the `ReconciliationLog` before processing a new transaction. If it exists, the transaction will be skipped.
