# Story 1.5: CSV Parsing Service

## Status
Done

## Story

**As a** System Administrator,
**I want** a backend service to parse Lloyds Bank and Stripe CSV files with data privacy enforcement,
**so that** I can securely import payment data while protecting sensitive information (discarding balances, hashing account numbers) according to privacy requirements.

## Acceptance Criteria

1. The service must parse Lloyds Bank CSV files and extract payment information
2. The service must parse Stripe transaction reports and extract payment information  
3. Bank account numbers must be immediately hashed and original values discarded (NFR2)
4. Balance fields from bank CSVs must never be stored in database or logs (NFR1)
5. The service must generate unique transaction fingerprints to prevent duplicate processing
6. Parsed data must be validated and structured for use by the matching service
7. The service must handle CSV parsing errors gracefully and provide meaningful error messages
8. The service must support both CSV file formats with appropriate field mapping

## Tasks / Subtasks

- [x] Task 1: Create CsvParsingService class structure (AC: 1, 2, 7)
  - [x] Set up CsvParsingService.ts in src/lib/ directory
  - [x] Define TypeScript interfaces for parsed payment data
  - [x] Implement error handling and validation framework
  - [x] Add logging capabilities for debugging and monitoring

- [x] Task 2: Implement Lloyds Bank CSV parsing (AC: 1, 3, 4)
  - [x] Parse CSV headers and validate expected columns
  - [x] Extract payment date, amount, and transaction description
  - [x] Extract and immediately hash bank account numbers
  - [x] Discard balance fields without storing anywhere
  - [x] Generate transaction fingerprints using date + amount + description hash

- [x] Task 3: Implement Stripe report parsing (AC: 2, 5)
  - [x] Parse Stripe CSV format and validate headers
  - [x] Extract payment data (source_id, amount, date)
  - [x] Use source_id as unique transaction fingerprint
  - [x] Map Stripe fields to common payment data structure

- [x] Task 4: Add data validation and structuring (AC: 6, 7)
  - [x] Validate parsed data integrity and completeness
  - [x] Apply business rules for payment amount and date formats
  - [x] Structure data for compatibility with matching service
  - [x] Implement comprehensive error reporting

- [x] Task 5: Add comprehensive testing (AC: All)
  - [x] Create unit tests for CSV parsing functions
  - [x] Test data privacy enforcement (balance discarding, account hashing)
  - [x] Test duplicate transaction fingerprint generation
  - [x] Test error handling with malformed CSV files
  - [x] Create integration tests with sample CSV files

## Dev Notes

### Previous Story Insights
**Key learnings from Story 1.3** [Source: Story 1.3 completion notes]:
- PaymentSource and ReconciliationLog models are now available in database schema
- Database relationships established between Contact ↔ PaymentSource ↔ ReconciliationLog
- Hashing approach for bank account numbers established using hashedIdentifier field
- Prisma client updated with new model types for data access

### Data Models and Schema
**ReconciliationLog Model** [Source: docs/architecture/data-models-and-schema-changes.md]:
- Purpose: Verifiable audit trail of all reconciled membership payments
- Key Attributes: id, transactionFingerprint (unique), paymentDate, amount, source, transactionRef, reconciledAt, reconciledByUserId, contactId
- Unique constraint on transactionFingerprint prevents duplicate processing

**PaymentSource Model** [Source: docs/architecture/data-models-and-schema-changes.md]:
- Purpose: Securely store hashed identifier for member's payment source
- Key Attributes: id, hashedIdentifier (unique), sourceType, contactId
- Used for bank account number hashes from CSV parsing

### Component Architecture
**CsvParsingService Location** [Source: docs/architecture/component-architecture.md]:
- File Location: src/lib/CsvParsingService.ts
- Purpose: Parses uploaded CSVs and applies data privacy rules
- Integration: Called by API routes in src/app/api/reconciliation/

### Data Privacy Requirements
**Critical Privacy Enforcement** [Source: docs/prd/requirements.md]:
- NFR1: Balance field from bank CSV must be discarded immediately, never stored in database or logs
- NFR2: Bank account numbers must be immediately hashed, original values discarded, only hash stored
- Data processing must happen in memory only, with no temporary storage of sensitive data

### Duplicate Transaction Handling
**Transaction Fingerprinting Strategy** [Source: docs/architecture/data-models-and-schema-changes.md]:
- For Stripe Reports: Use unique source_id as fingerprint
- For Bank CSVs: Generate fingerprint by hashing combined Transaction date + Credit Amount + Transaction Description
- Import Logic: Check if fingerprint exists in ReconciliationLog before processing
- Skip processing if fingerprint already exists to prevent duplicates

### Technical Context
**Technology Stack** [Source: docs/architecture/tech-stack-alignment.md]:
- TypeScript 5.9.2 for all new code
- Prisma 6.13.0 for database access
- Node.js built-in crypto module for hashing operations
- CSV parsing libraries (csv-parser or similar)

**Integration Approach** [Source: docs/architecture/enhancement-scope-and-integration-strategy.md]:
- Backend logic resides in src/lib/ directory
- Service consumed by API routes in src/app/api/reconciliation/
- Uses existing Prisma client (src/lib/prisma.ts) for database operations

### File Locations
**Implementation Files**:
- src/lib/CsvParsingService.ts - Main CSV parsing service
- src/lib/types/payment.ts - TypeScript interfaces for payment data (if needed)
- src/__tests__/lib/CsvParsingService.test.ts - Unit tests

**Integration Points**:
- src/lib/prisma.ts - Existing Prisma client for database access
- src/app/api/reconciliation/upload/route.ts - API endpoint that will consume this service

### Security Considerations
- Never log sensitive data (account numbers, balances)
- Use secure hashing algorithms for account number hashing
- Ensure memory cleanup after processing sensitive data
- Validate all input data to prevent injection attacks

### Testing

**Framework**: Jest & React Testing Library [Source: docs/architecture/tech-stack-alignment.md]
**Test Location**: src/__tests__/lib/ following established patterns from existing services
**Coverage Requirements**: Comprehensive coverage of CSV parsing, data privacy enforcement, and error handling

**Required Test Cases**:
- Lloyds Bank CSV parsing with various data formats
- Stripe report parsing and field mapping  
- Data privacy enforcement (balance discarding, account hashing)
- Transaction fingerprint generation and uniqueness
- Error handling with malformed CSV files
- Integration with database models (PaymentSource, ReconciliationLog)
- Memory safety and data cleanup validation

**Test Data Requirements**:
- Sample Lloyds Bank CSV files with various transaction types
- Sample Stripe report CSV files
- Malformed CSV files for error testing
- Edge cases (empty files, missing columns, invalid dates/amounts)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-08 | 1.0 | Initial story creation for CSV parsing service with data privacy enforcement | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
All tests passed successfully. Console logs show proper CSV parsing execution flow.

### Completion Notes List
- Implemented complete CsvParsingService with Lloyds Bank and Stripe CSV parsing
- Data privacy requirements NFR1 and NFR2 fully enforced (balance discarding, account hashing)
- Transaction fingerprinting implemented with duplicate detection
- Comprehensive error handling and validation
- Full test suite with 77 passing tests covering all acceptance criteria

### File List
- `src/lib/CsvParsingService.ts` - Main CSV parsing service implementation
- `src/__tests__/lib/CsvParsingService.test.ts` - Comprehensive test suite

## QA Results

_Results from QA Agent review will be populated here after implementation._