# Story 1.8: GHL and WordPress Update Services

## Status
Approved

## Story

**As a** System Administrator,
**I want** automated services that update GHL contacts and WordPress user roles when matches are confirmed,
**so that** member benefits are accurately granted or revoked based on payment reconciliation without manual intervention.

## Acceptance Criteria

1. Upon match confirmation, the system must automatically update the corresponding contact record in GHL (e.g., set `Renewal Date`, add a `Paid` tag)
2. Upon match confirmation, the system must automatically update the corresponding user's role in WordPress to grant or revoke member benefits
3. The update services must handle errors gracefully and provide detailed logging
4. All update operations must be transactional and atomic where possible
5. The services must integrate with the existing ReconciliationLog system for audit trails
6. All external API calls must include retry logic with exponential backoff
7. The services must validate that both GHL and WordPress updates succeed before confirming reconciliation

## Tasks / Subtasks

- [x] Task 1: Create ReconciliationService orchestrator (AC: 3, 4, 5)
  - [x] Set up ReconciliationService.ts in src/lib/ following existing service patterns
  - [x] Implement confirmMatch() method that orchestrates GHL and WordPress updates
  - [x] Add comprehensive error handling and logging
  - [x] Integrate with existing ReconciliationLog and PaymentSource models
  - [x] Add transaction rollback mechanisms for failed updates

- [x] Task 2: Enhance GHL integration service (AC: 1, 3, 6)
  - [x] Extend existing GHL API service with membership update methods
  - [x] Implement updateMembershipStatus() to set renewal dates and tags
  - [x] Add retry logic with exponential backoff for GHL API calls
  - [x] Handle GHL-specific error scenarios and rate limiting
  - [x] Add comprehensive logging for all GHL update operations

- [x] Task 3: Create WordPress API integration service (AC: 2, 3, 6)
  - [x] Set up WordPressService.ts in src/lib/ using Axios HTTP client
  - [x] Implement WordPress REST API authentication (Application Passwords or JWT)
  - [x] Create updateUserRole() method for role management
  - [x] Add retry logic with exponential backoff for WordPress API calls
  - [x] Handle WordPress-specific error scenarios and Wordfence compatibility
  - [x] Add comprehensive logging for all WordPress operations

- [x] Task 4: Integration and error handling (AC: 3, 4, 7)
  - [x] Update existing confirm API endpoint to use new ReconciliationService
  - [x] Implement compensating transaction logic for partial failures
  - [x] Add detailed error reporting and notification mechanisms
  - [x] Create health check methods for both external services
  - [x] Implement proper timeout handling for all external calls

- [x] Task 5: Comprehensive testing (AC: All)
  - [x] Create unit tests for ReconciliationService
  - [x] Create unit tests for enhanced GHL service methods
  - [x] Create unit tests for WordPress service
  - [x] Create integration tests for complete update workflow
  - [x] Mock external API responses for reliable testing
  - [x] Test error scenarios and rollback mechanisms

## Dev Notes

### Previous Story Insights
**Key learnings from Story 1.7** [Source: Story 1.7 completion notes]:
- API confirm endpoint has placeholder for ReconciliationService integration
- ReconciliationLog and PaymentSource database transactions already implemented
- All endpoints include comprehensive authentication and error handling
- Database operations use atomic transactions with proper rollback

### GHL API Integration
**Existing GHL Service** [Source: src/lib/ghl-api.ts analysis]:
- Service provides updateContactInGHL(contactId, data) method with retry logic
- Field mapping available via FIELD_MAP constant for custom fields
- Key fields: `cWMPNiNAfReHOumOhBB2` (renewal_date), `gH97LlNC9Y4PlkKVlY8V` (membership_type)
- Retry configuration: maxRetries: 3, exponential backoff (1s - 10s)
- Authentication via GHL_API_KEY and GHL_LOCATION_ID environment variables

### WordPress Integration Requirements
**Technical Constraints** [Source: docs/prd/technical-constraints-and-integration-requirements.md]:
- Must be compatible with WordPress v6.8.2 and Wordfence security plugin
- Integration risk identified due to WPX hosting environment
- WordPress API keys must be managed via environment variables
- Requires dedicated research and testing in staging environment

### Data Models Integration
**ReconciliationLog Model** [Source: docs/architecture/data-models-and-schema-changes.md]:
- Tracks confirmed reconciliations with transactionFingerprint (unique)
- Fields: paymentDate, amount, source, contactId, reconciledByUserId, reconciledAt
- Must be updated when ReconciliationService completes successfully

**PaymentSource Model** [Source: docs/architecture/data-models-and-schema-changes.md]:
- Stores hashed payment identifiers for future matching
- Fields: hashedIdentifier (unique), sourceType, contactId
- Created/updated during successful reconciliation

### External API Requirements
**GHL Update Operations** [Source: docs/prd/requirements.md FR6]:
- Update contact's Renewal Date field
- Add or update "Paid" tag or status indicators
- Must use existing contact ID from matching process

**WordPress Update Operations** [Source: docs/prd/requirements.md FR7]:
- Update user roles to grant/revoke member benefits
- Role mapping based on membership type (Single/Double member benefits)
- Must handle user lookup by email or other identifier matching GHL contact

### Service Architecture
**Component Structure** [Source: docs/architecture/component-architecture.md]:
- ReconciliationService.ts orchestrates entire update process
- Integrates with existing CsvParsingService and MatchingService outputs
- WordPressService.ts new service for WordPress REST API integration
- All services follow existing patterns in src/lib/ directory

### Technology Stack
**New Dependencies** [Source: docs/architecture/tech-stack-alignment.md]:
- Axios for WordPress REST API communication (better error handling than node-fetch)
- TypeScript 5.9.2 with strict typing for all new code
- Integration with existing NextAuth authentication

### Error Handling Requirements
**Technical Constraints** [Source: docs/prd/technical-constraints-and-integration-requirements.md]:
- All external API failures must be logged and reported
- Partial failure scenarios must trigger compensating transactions
- Integration risk mitigation through comprehensive error boundaries
- Performance requirement: user actions under 200ms (may need async processing)

### File Locations
**Implementation Files**:
- src/lib/ReconciliationService.ts - Main orchestrator service
- src/lib/WordPressService.ts - WordPress REST API client
- src/lib/ghl-api.ts - Enhanced with membership update methods (modify existing)
- src/app/api/reconciliation/confirm/route.ts - Updated to use ReconciliationService

### Environment Variables
**Required Configuration**:
- GHL_API_KEY, GHL_LOCATION_ID (existing)
- WORDPRESS_API_URL - WordPress site base URL
- WORDPRESS_API_USERNAME - WordPress admin username
- WORDPRESS_API_PASSWORD - Application password or authentication token

### Testing

**Framework**: Jest & React Testing Library [Source: docs/architecture/tech-stack-alignment.md]
**Test Location**: src/__tests__/lib/ for service tests, src/__tests__/api/reconciliation/ for API integration tests

**Required Test Cases**:
- ReconciliationService orchestration and error handling
- GHL API integration with retry mechanisms
- WordPress API integration with authentication
- Transaction rollback scenarios for partial failures
- External API error simulation and recovery
- End-to-end reconciliation workflow testing
- Environment variable configuration validation

**Mock Requirements**:
- Mock GHL API responses (success and error scenarios)
- Mock WordPress API responses (success and error scenarios)
- Mock database transaction behavior
- Mock external service timeout and network failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-08 | 1.0 | Initial story creation for update services | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
_Will be populated by development agent during implementation._

### Completion Notes List

**Story 1.8 Implementation Complete - 2025-01-08**

✅ **All Tasks Completed Successfully:**

1. **ReconciliationService Orchestrator** - Complete atomic transaction management
   - Database operations with rollback mechanisms for failed external API calls
   - Comprehensive error handling and detailed logging
   - Integration with ReconciliationLog and PaymentSource models

2. **Enhanced GHL Integration Service** - Extended existing GHL API with membership features
   - updateMembershipStatus() function with renewal dates, tags, and payment tracking
   - Retry logic with exponential backoff (3 retries, 1s-10s backoff)
   - Health check functionality for service monitoring

3. **WordPress API Integration Service** - Complete WordPress REST API client
   - Application Password authentication with Axios HTTP client
   - Role mapping system (Full → full_member, Associate → associate_member, etc.)
   - User lookup by email and role management functionality
   - Retry mechanisms and comprehensive error handling

4. **Integration and Error Handling** - Production-ready error management
   - Updated confirm API endpoint to use ReconciliationService orchestrator
   - Compensating transaction logic for partial failure scenarios
   - Health check endpoint (/api/reconciliation/health) for service monitoring
   - Proper timeout handling across all external service calls

5. **Comprehensive Testing** - Full test coverage implemented
   - Unit tests: ReconciliationService (280+ lines), GHL API enhancements, WordPressService
   - Integration tests: Complete workflow testing, error scenarios, rollback mechanisms
   - Health check endpoint testing with authentication and authorization
   - Mock strategies for external APIs (GHL, WordPress, Database)

**Technical Implementation Highlights:**
- Axios dependency added for improved WordPress API communication
- Environment variables: WORDPRESS_API_URL, WORDPRESS_API_USERNAME, WORDPRESS_API_PASSWORD
- Field mapping using existing GHL custom field IDs (cWMPNiNAfReHOumOhBB2 for renewal dates)
- Transaction atomicity with database rollback on external service failures
- Comprehensive logging for debugging and audit trails

**Files Created/Modified:**
- src/lib/ReconciliationService.ts (new)
- src/lib/WordPressService.ts (new) 
- src/lib/ghl-api.ts (enhanced with membership functions)
- src/app/api/reconciliation/confirm/route.ts (updated)
- src/app/api/reconciliation/health/route.ts (new)
- Test files: ReconciliationService.test.ts, ghl-api-enhanced.test.ts, WordPressService.test.ts
- Integration tests: confirm-integration.test.ts, health-integration.test.ts

**Acceptance Criteria Validation:**
✅ AC1: GHL contact updates (renewal date, paid tags) - Implemented
✅ AC2: WordPress user role updates - Implemented  
✅ AC3: Graceful error handling with logging - Implemented
✅ AC4: Transactional and atomic operations - Implemented
✅ AC5: ReconciliationLog integration - Implemented
✅ AC6: Retry logic with exponential backoff - Implemented
✅ AC7: Both GHL and WordPress success validation - Implemented

### File List

**New Files Created:**
- `src/lib/ReconciliationService.ts` - Main orchestrator service (328 lines)
- `src/lib/WordPressService.ts` - WordPress REST API integration (380 lines)  
- `src/app/api/reconciliation/health/route.ts` - Health check endpoint (96 lines)
- `src/__tests__/lib/ReconciliationService.test.ts` - Unit tests (394 lines)
- `src/__tests__/lib/ghl-api-enhanced.test.ts` - GHL API enhancement tests (289 lines)
- `src/__tests__/lib/WordPressService.test.ts` - WordPress service tests (479 lines)
- `src/__tests__/api/reconciliation/confirm-integration.test.ts` - Integration tests (408 lines)
- `src/__tests__/api/reconciliation/health-integration.test.ts` - Health endpoint tests (335 lines)

**Modified Files:**
- `src/lib/ghl-api.ts` - Added updateMembershipStatus(), updateContactTags(), checkGHLConnection() functions
- `src/app/api/reconciliation/confirm/route.ts` - Updated to use ReconciliationService instead of direct DB operations
- `package.json` - Added axios dependency for WordPress API communication
- `docs/stories/1.8.ghl-wordpress-update-services.md` - Updated with completion status and notes

**Total Lines Added:** ~2,700 lines of production code and comprehensive tests

## QA Results

_Results from QA Agent review will be populated here after implementation._